<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Income Dashboard Pro - Integrated</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">

  <!-- Google APIs -->
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --primary: #6366f1;
      --success: #10b981;
      --danger: #ef4444;
      --warning: #f59e0b;
      --info: #3b82f6;
      --bg: #0f172a;
      --text: #f1f5f9;
      --text-secondary: #cbd5e1;
      --border: #475569;
    }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg, var(--bg) 0%, #1a1f3a 100%);
      color: var(--text);
      min-height: 100vh;
    }
    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
      pointer-events: none;
      z-index: 0;
    }
    .container {
      position: relative;
      z-index: 1;
      max-width: 1800px;
      margin: 0 auto;
      padding: 40px 20px;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 40px;
      flex-wrap: wrap;
      gap: 20px;
    }
    header h1 {
      font-size: 36px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .header-right {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
    .date-display {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 12px 20px;
      text-align: center;
    }
    .date-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
      font-family: 'Space Mono';
    }
    .sync-controls {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    #googleSignInButton {
      background: white;
      color: #333;
      padding: 10px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    #googleSignInButton:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .status-badge {
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      background: rgba(239, 68, 68, 0.2);
      color: #fca5a5;
      border: 1px solid rgba(239, 68, 68, 0.5);
      animation: pulse 2s infinite;
    }
    .status-badge.connected {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
      border-color: rgba(16, 185, 129, 0.5);
      animation: none;
    }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

    .tabs {
      display: flex;
      gap: 12px;
      margin-bottom: 30px;
      background: rgba(30, 41, 59, 0.8);
      padding: 12px;
      border-radius: 12px;
      flex-wrap: wrap;
      overflow-x: auto;
    }
    .tab-btn {
      padding: 10px 16px;
      background: transparent;
      border: 2px solid transparent;
      color: var(--text-secondary);
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: all 0.3s ease;
      font-size: 11px;
      white-space: nowrap;
    }
    .tab-btn.active {
      background: rgba(99, 102, 241, 0.2);
      border-color: var(--primary);
      color: var(--primary);
    }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .card {
      background: rgba(30, 41, 59, 0.8);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 16px;
      padding: 32px;
      max-height: 85vh;
      overflow-y: auto;
    }
    .card-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
    .form-group { margin-bottom: 18px; }
    label {
      display: block;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 6px;
      color: var(--text-secondary);
      text-transform: uppercase;
    }
    select, input {
      width: 100%;
      padding: 10px 14px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 13px;
      font-family: 'Inter', sans-serif;
    }
    select:focus, input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }
    .anketa-selector {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px;
      margin-bottom: 16px;
    }
    .anketa-checkbox {
      display: flex;
      align-items: center;
      padding: 8px;
      background: rgba(99, 102, 241, 0.05);
      border: 2px solid rgba(99, 102, 241, 0.2);
      border-radius: 6px;
      cursor: pointer;
    }
    .anketa-checkbox:hover { background: rgba(99, 102, 241, 0.1); border-color: var(--primary); }
    .anketa-checkbox input { width: 16px; height: 16px; margin-right: 6px; accent-color: var(--primary); }
    .anketa-checkbox label { margin: 0; font-size: 11px; cursor: pointer; }
    .anketa-inputs {
      background: rgba(99, 102, 241, 0.05);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }
    .anketa-inputs-header {
      font-weight: 600;
      font-size: 12px;
      color: var(--primary);
      padding-bottom: 10px;
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
      margin-bottom: 12px;
    }
    .income-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px;
    }
    .income-group { position: relative; }
    .income-label {
      position: absolute;
      left: 10px;
      top: 8px;
      font-size: 8px;
      font-weight: 700;
      color: var(--primary);
      text-transform: uppercase;
      background: rgba(30, 41, 59, 0.8);
      padding: 0 2px;
    }
    button {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: 'Inter', sans-serif;
    }
    .btn-primary {
      background: var(--primary);
      color: white;
      width: 100%;
      margin-top: 16px;
    }
    .btn-primary:hover { background: #4f46e5; transform: translateY(-2px); }
    .btn-secondary {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-secondary);
      width: auto;
      padding: 8px 12px;
      font-size: 10px;
    }
    .btn-secondary:hover { background: rgba(99, 102, 241, 0.1); border-color: var(--primary); }

    .success-message {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 12px;
      z-index: 1000;
      animation: slideInRight 0.5s ease-out;
      max-width: 520px;
    }
    @keyframes slideInRight {
      from { opacity: 0; transform: translateX(400px); }
      to { opacity: 1; transform: translateX(0); }
    }

    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 2000;
      justify-content: center;
      align-items: center;
      overflow-y: auto;
    }
    .modal.active { display: flex; }
    .modal-content {
      background: rgba(30, 41, 59, 0.95);
      border: 1px solid rgba(71, 85, 105, 0.3);
      border-radius: 12px;
      padding: 28px;
      max-width: 600px;
      width: 90%;
      margin: 20px;
    }
    .modal-header {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 18px;
      display: flex;
      justify-content: space-between;
    }
    .close-modal { background: transparent; border: none; color: var(--text); font-size: 20px; cursor: pointer; }

    .report-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: rgba(99, 102, 241, 0.05);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 10px;
      padding: 14px;
      text-align: center;
    }
    .stat-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
    .stat-value { font-size: 18px; font-weight: 700; color: var(--success); font-family: 'Space Mono'; }

    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 11px;
    }
    .report-table th {
      background: rgba(99, 102, 241, 0.1);
      padding: 8px;
      text-align: left;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-secondary);
      border-bottom: 2px solid rgba(99, 102, 241, 0.2);
    }
    .report-table td { padding: 8px; border-bottom: 1px solid rgba(99, 102, 241, 0.1); }

    .section-title { font-size: 13px; font-weight: 700; margin-top: 24px; margin-bottom: 10px; color: var(--primary); }

    .transaction-row {
      background: rgba(99, 102, 241, 0.05);
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 8px;
      padding: 10px;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .setup-info {
      background: rgba(99, 102, 241, 0.1);
      border: 2px dashed var(--primary);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      color: var(--text-secondary);
    }
    .setup-info h2 {
      color: var(--primary);
      margin-bottom: 10px;
      font-size: 16px;
    }
  </style>
</head>

<body>
<div class="container">
  <header>
    <h1>üí∞ Income Dashboard Pro</h1>
    <div class="header-right">
      <div class="date-display">
        <div class="date-value" id="currentDate"></div>
      </div>
      <div class="sync-controls">
        <div class="status-badge" id="syncStatus">üî¥ Not Connected</div>
        <button id="googleSignInButton" onclick="handleGoogleSignIn()">üìä Sign in with Google</button>
      </div>
    </div>
  </header>

  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('add-income', event)">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
    <button class="tab-btn" onclick="switchTab('edit-income', event)">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    <button class="tab-btn" onclick="switchTab('dashboard', event)">üìä Dashboard</button>
    <button class="tab-btn" onclick="switchTab('reports', event)">üìà –ü–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º</button>
    <button class="tab-btn" onclick="switchTab('advances', event)">üí∞ –ê–≤–∞–Ω—Å—ã/–ó–∞—Ä–ø–ª–∞—Ç–∞</button>
    <button class="tab-btn" onclick="switchTab('penalties', event)">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</button>
    <button class="tab-btn" onclick="switchTab('settings', event)">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
    <button class="tab-btn" onclick="switchTab('sheets', event)">üìã Google Sheets</button>
  </div>

  <!-- TAB 1 -->
  <div id="add-income" class="tab-content active">
    <div class="card">
      <div class="card-title">üìù –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</div>

      <div class="form-group">
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
        <select id="operator" onchange="updateAnketaSelector()">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
        </select>
      </div>

      <div class="form-group">
        <label>–°–º–µ–Ω–∞ *</label>
        <select id="shift">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
          <option value="–£—Ç—Ä–æ (08:00-14:00)">–£—Ç—Ä–æ (08:00-14:00)</option>
          <option value="–î–µ–Ω—å (14:00-20:00)">–î–µ–Ω—å (14:00-20:00)</option>
          <option value="–í–µ—á–µ—Ä (20:00-02:00)">–í–µ—á–µ—Ä (20:00-02:00)</option>
          <option value="–ù–æ—á—å (02:00-08:00)">–ù–æ—á—å (02:00-08:00)</option>
        </select>
      </div>

      <div class="form-group">
        <label>–ê–Ω–∫–µ—Ç—ã *</label>
        <div class="anketa-selector" id="anketaSelector"></div>
      </div>

      <div id="anketaInputsContainer"></div>

      <div class="form-group">
        <label>% –û–ø–µ—Ä–∞—Ç–æ—Ä—É</label>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
          <div>
            <small style="color: var(--text-secondary); font-size: 10px;">OnlyFans</small>
            <input type="number" id="onlyfansPercent" value="20" min="0" max="100" step="1">
          </div>
          <div>
            <small style="color: var(--text-secondary); font-size: 10px;">–ö—Ä–∏–ø—Ç–æ</small>
            <input type="number" id="cryptoPercent" value="20" min="0" max="100" step="1">
          </div>
          <div>
            <small style="color: var(--text-secondary); font-size: 10px;">PayPal</small>
            <input type="number" id="paypalPercent" value="15" min="0" max="100" step="1">
          </div>
        </div>
      </div>

      <button class="btn-primary" onclick="addIncome()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
    </div>
  </div>

  <!-- TAB 2 -->
  <div id="edit-income" class="tab-content">
    <div class="card">
      <div class="card-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã</div>
      <div id="editContainer"></div>
    </div>
  </div>

  <!-- TAB 3 -->
  <div id="dashboard" class="tab-content">
    <div class="card">
      <div class="card-title">üìä –û–±—â–∏–π Dashboard</div>
      <div id="dashboardContent"></div>
    </div>
  </div>

  <!-- TAB 4 -->
  <div id="reports" class="tab-content">
    <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
      <div style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 24px; max-height: 85vh; overflow-y: auto;">
        <h3 style="margin-bottom: 10px; font-size: 13px;">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
        <div class="operator-list" id="operatorListReport"></div>
      </div>
      <div class="report-content" id="reportContent" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 24px; max-height: 85vh; overflow-y: auto;"></div>
    </div>
  </div>

  <!-- TAB 5 -->
  <div id="advances" class="tab-content">
    <div class="card">
      <div class="card-title">üí∞ –ê–≤–∞–Ω—Å—ã –∏ –ó–∞—Ä–ø–ª–∞—Ç–∞</div>

      <div class="form-group">
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
        <select id="advanceOperator" onchange="updateAdvancesUI()">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
        </select>
      </div>

      <div class="form-group">
        <label>–¢–∏–ø –≤—ã–ø–ª–∞—Ç—ã *</label>
        <select id="paymentType">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
          <option value="advance">üí∞ –ê–≤–∞–Ω—Å</option>
          <option value="salary">üíµ –ó–∞—Ä–ø–ª–∞—Ç–∞</option>
        </select>
      </div>

      <div class="form-group">
        <label>–°—É–º–º–∞ *</label>
        <input type="number" id="advanceAmount" placeholder="0.00" step="0.01" min="0">
      </div>

      <button class="btn-primary" onclick="addAdvance()">+ –í—ã–¥–∞—Ç—å</button>

      <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è</div>
      <div id="advancesHistory"></div>
    </div>
  </div>

  <!-- TAB 6 -->
  <div id="penalties" class="tab-content">
    <div class="card">
      <div class="card-title">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</div>

      <div class="form-group">
        <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
        <select id="penaltyOperator" onchange="updatePenaltiesUI()">
          <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
        </select>
      </div>

      <div class="form-group">
        <label>–°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞ *</label>
        <input type="number" id="penaltyAmount" placeholder="0.00" step="0.01" min="0">
      </div>

      <div class="form-group">
        <label>–ü—Ä–∏—á–∏–Ω–∞</label>
        <input type="text" id="penaltyReason" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞">
      </div>

      <button class="btn-primary" onclick="addPenalty()">‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∞—Ñ</button>

      <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è</div>
      <div id="penaltiesHistory"></div>
    </div>
  </div>

  <!-- TAB 7 -->
  <div id="settings" class="tab-content">
    <div class="card">
      <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

      <h3 style="margin-top: 16px; margin-bottom: 10px; font-size: 13px;">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
      <div id="operatorsList"></div>
      <button class="btn-primary" onclick="openModal('addOperatorModal')" style="width: auto; margin-top: 10px;">+ –û–ø–µ—Ä–∞—Ç–æ—Ä</button>

      <h3 style="margin-top: 24px; margin-bottom: 10px; font-size: 13px;">–ê–Ω–∫–µ—Ç—ã</h3>
      <div id="anketasList"></div>
      <button class="btn-primary" onclick="openModal('addAnketaModal')" style="width: auto; margin-top: 10px;">+ –ê–Ω–∫–µ—Ç–∞</button>

      <h3 style="margin-top: 24px; margin-bottom: 10px; font-size: 13px;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</h3>
      <div id="adminList"></div>
      <button class="btn-primary" onclick="openModal('addAdminModal')" style="width: auto; margin-top: 10px;">+ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
    </div>
  </div>

  <!-- TAB 8 -->
  <div id="sheets" class="tab-content">
    <div class="card">
      <div class="card-title">üìã Google Sheets</div>
      <div id="sheetsContainer" style="margin-top: 20px;">
        <div class="setup-info">
          <h2>üìä –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets</h2>
          <p style="margin-bottom: 16px;">–ù–∞–∂–º–∏—Ç–µ ‚ÄúSign in with Google‚Äù, –∑–∞—Ç–µ–º –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –º–µ–∂–¥—É –∞–¥–º–∏–Ω–∞–º–∏ —á–µ—Ä–µ–∑ –æ–±—â—É—é —Ç–∞–±–ª–∏—Ü—É.</p>
          <button class="btn-primary" onclick="handleGoogleSignIn()" style="width: auto;">–í–æ–π—Ç–∏ —Å Google</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- MODALS -->
<div id="addOperatorModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      <button class="close-modal" onclick="closeModal('addOperatorModal')">√ó</button>
    </div>
    <div class="form-group">
      <label>–ò–º—è</label>
      <input type="text" id="newOperatorName">
    </div>
    <button class="btn-primary" onclick="addOperator()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<div id="addAnketaModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É
      <button class="close-modal" onclick="closeModal('addAnketaModal')">√ó</button>
    </div>
    <div class="form-group">
      <label>–ò–º—è</label>
      <input type="text" id="newAnketaName">
    </div>
    <button class="btn-primary" onclick="addAnketa()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<div id="addAdminModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
      <button class="close-modal" onclick="closeModal('addAdminModal')">√ó</button>
    </div>
    <div class="form-group">
      <label>–ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
      <input type="text" id="newAdminName">
    </div>
    <button class="btn-primary" onclick="addAdmin()">–î–æ–±–∞–≤–∏—Ç—å</button>
  </div>
</div>

<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
      <button class="close-modal" onclick="closeModal('editModal')">√ó</button>
    </div>
    <div id="editFormContent"></div>
    <button class="btn-primary" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  let allAnkety = JSON.parse(localStorage.getItem('allAnkety') || '["Succuba","Mommy","Nola","Lust","Mermaid","Stacy","Fitness","Caitlyn"]');
  let allOperators = JSON.parse(localStorage.getItem('allOperators') || '["Operator 1","Operator 2","Operator 3"]');
  let allAdmins = JSON.parse(localStorage.getItem('allAdmins') || '["Admin 1","Admin 2"]');
  const ADMIN_PERCENT = 8;

  const CLIENT_ID = '752768254066-ba8ilut3p4s17068h65voakgmtao2bu0.apps.googleusercontent.com';
  const SPREADSHEET_ID = '1rZJIgN0C38ltZDlKFPnmz0I2G5vQPq8Z9fo9r2l8Uuc';

  const SCOPES = [
    'https://www.googleapis.com/auth/spreadsheets',
    'https://www.googleapis.com/auth/userinfo.email',
    'https://www.googleapis.com/auth/userinfo.profile',
    'openid'
  ].join(' ');

  let tokenClient = null;
  let accessToken = null;
  let userLoggedIn = false;
  let gapiInited = false;
  let gisInited = false;

  // =========================
  // INIT
  // =========================
  function init() {
    updateDate();
    updateOperatorSelects();
    updateSettingsUI();
    updateEditTab();
    updateReportsOperatorList();
    updateAdvanceSelector();
    updatePenaltySelector();
    updateAnketaSelector();

    initGoogleClients();

    setInterval(updateDate, 1000);
  }

  function updateDate() {
    const now = new Date();
    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
    document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', options);
  }

  // =========================
  // GOOGLE INIT
  // =========================
  function initGoogleClients() {
    const wait = () => {
      const hasGapi = typeof window.gapi !== 'undefined';
      const hasGoogle = typeof window.google !== 'undefined'
        && window.google.accounts
        && window.google.accounts.oauth2;

      if (!hasGapi || !hasGoogle) {
        setTimeout(wait, 200);
        return;
      }

      window.gapi.load('client', async () => {
        try {
          await window.gapi.client.init({
            discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
          });
          gapiInited = true;
        } catch (e) {
          console.error(e);
          showError('gapi init error (—Å–º. console)');
        }
      });

      tokenClient = window.google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (!resp || resp.error) {
            showError('Google auth error: ' + (resp?.error || 'unknown'));
            setDisconnected();
            return;
          }

          accessToken = resp.access_token;
          userLoggedIn = true;

          try { window.gapi.client.setToken({ access_token: accessToken }); } catch {}

          let name = 'Google User';
          let email = '';
          try {
            const me = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
              headers: { Authorization: 'Bearer ' + accessToken }
            }).then(r => r.json());
            name = me?.name || name;
            email = me?.email || email;
          } catch {}

          setConnected(name, email);

          await ensureSheetStructure();
          await pullIncomeFromSheets();

          updateEditTab();
          generateDashboard();
          showSuccess('‚úì Connected & synced');
        }
      });

      gisInited = true;
    };

    wait();
  }

  function handleGoogleSignIn() {
    if (!gisInited) {
      showError('Google libs –µ—â—ë –≥—Ä—É–∑—è—Ç—Å—è. –ü–æ–¥–æ–∂–¥–∏ 1-2 —Å–µ–∫.');
      return;
    }
    if (userLoggedIn) {
      setDisconnected();
      showSuccess('‚úì –í—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
      return;
    }
    tokenClient.requestAccessToken({ prompt: 'consent' });
  }

  function setConnected(name, email) {
    const status = document.getElementById('syncStatus');
    status.textContent = 'üü¢ Connected';
    status.classList.add('connected');

    const btn = document.getElementById('googleSignInButton');
    btn.textContent = email ? `üë§ ${name}` : `üë§ ${name}`;
  }

  function setDisconnected() {
    userLoggedIn = false;
    accessToken = null;
    try { window.gapi.client.setToken(null); } catch {}
    const status = document.getElementById('syncStatus');
    status.textContent = 'üî¥ Not Connected';
    status.classList.remove('connected');
    document.getElementById('googleSignInButton').textContent = 'üìä Sign in with Google';
  }

  async function sanityCheckSheet() {
    try {
      await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
      return true;
    } catch (e) {
      console.error(e);
      showError('–ù–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–∞–±–ª–∏—Ü–µ. Share ‚Üí Editor –¥–ª—è –∞–¥–º–∏–Ω–æ–≤.');
      return false;
    }
  }

  async function ensureSheetStructure() {
    if (!userLoggedIn || !accessToken || !gapiInited) return;

    const ok = await sanityCheckSheet();
    if (!ok) return;

    const ss = await window.gapi.client.sheets.spreadsheets.get({ spreadsheetId: SPREADSHEET_ID });
    const titles = (ss.result.sheets || []).map(s => s.properties.title);

    if (!titles.includes('–î–æ—Ö–æ–¥—ã')) {
      await window.gapi.client.sheets.spreadsheets.batchUpdate({
        spreadsheetId: SPREADSHEET_ID,
        resource: { requests: [{ addSheet: { properties: { title: '–î–æ—Ö–æ–¥—ã' } } }] }
      });
    }

    const header = [[
      'ID','–î–∞—Ç–∞','–í—Ä–µ–º—è','–û–ø–µ—Ä–∞—Ç–æ—Ä','–ê–Ω–∫–µ—Ç–∞','–°–º–µ–Ω–∞',
      'OnlyFans –ë—Ä—É—Ç—Ç–æ','OnlyFans %','OnlyFans –ß–∏—Å—Ç—ã–º–∏',
      '–ö—Ä–∏–ø—Ç–æ –ë—Ä—É—Ç—Ç–æ','–ö—Ä–∏–ø—Ç–æ %','–ö—Ä–∏–ø—Ç–æ –ß–∏—Å—Ç—ã–º–∏',
      'PayPal –ë—Ä—É—Ç—Ç–æ','PayPal %','PayPal –ß–∏—Å—Ç—ã–º–∏',
      '–û–±—â–∏–π –ë—Ä—É—Ç—Ç–æ','–û–±—â–∏–π –ß–∏—Å—Ç—ã–º–∏'
    ]];

    try {
      const get = await window.gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: '–î–æ—Ö–æ–¥—ã!A1:Q1'
      });
      const hasHeader = (get.result.values && get.result.values[0] && get.result.values[0][0] === 'ID');
      if (!hasHeader) {
        await window.gapi.client.sheets.spreadsheets.values.update({
          spreadsheetId: SPREADSHEET_ID,
          range: '–î–æ—Ö–æ–¥—ã!A1',
          valueInputOption: 'RAW',
          resource: { values: header }
        });
      }
    } catch {
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: '–î–æ—Ö–æ–¥—ã!A1',
        valueInputOption: 'RAW',
        resource: { values: header }
      });
    }
  }

  async function pullIncomeFromSheets() {
    if (!userLoggedIn || !accessToken) return;

    try {
      const res = await window.gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: SPREADSHEET_ID,
        range: '–î–æ—Ö–æ–¥—ã!A2:Q'
      });

      const rows = res.result.values || [];
      const toNum = (x) => (x === undefined || x === null || x === '') ? 0 : Number(x);

      const parsed = rows.map(r => ({
        id: r[0] || String(Date.now() + Math.random()),
        date: r[1] || '',
        timestamp: r[2] || '',
        operator: r[3] || '',
        anketa: r[4] || '',
        shift: r[5] || '',
        day: r[1] ? (new Date(r[1]).getDate()) : (new Date().getDate()),
        sources: {
          onlyfans: { gross: toNum(r[6]),  percent: toNum(r[7]),  operatorShare: toNum(r[8])  },
          crypto:   { gross: toNum(r[9]),  percent: toNum(r[10]), operatorShare: toNum(r[11]) },
          paypal:   { gross: toNum(r[12]), percent: toNum(r[13]), operatorShare: toNum(r[14]) }
        },
        total: { gross: toNum(r[15]), operatorShare: toNum(r[16]) }
      })).filter(x => x.operator || x.anketa || x.timestamp);

      localStorage.setItem('incomeData', JSON.stringify(parsed));
    } catch (e) {
      console.error(e);
      showError('–ù–µ —Å–º–æ–≥ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑ Sheets. –ü—Ä–æ–≤–µ—Ä—å –¥–æ—Å—Ç—É–ø.');
    }
  }

  async function pushIncomeToSheets() {
    if (!userLoggedIn || !accessToken) return;

    const data = JSON.parse(localStorage.getItem('incomeData') || '[]');
    const values = [
      ['ID','–î–∞—Ç–∞','–í—Ä–µ–º—è','–û–ø–µ—Ä–∞—Ç–æ—Ä','–ê–Ω–∫–µ—Ç–∞','–°–º–µ–Ω–∞',
       'OnlyFans –ë—Ä—É—Ç—Ç–æ','OnlyFans %','OnlyFans –ß–∏—Å—Ç—ã–º–∏',
       '–ö—Ä–∏–ø—Ç–æ –ë—Ä—É—Ç—Ç–æ','–ö—Ä–∏–ø—Ç–æ %','–ö—Ä–∏–ø—Ç–æ –ß–∏—Å—Ç—ã–º–∏',
       'PayPal –ë—Ä—É—Ç—Ç–æ','PayPal %','PayPal –ß–∏—Å—Ç—ã–º–∏',
       '–û–±—â–∏–π –ë—Ä—É—Ç—Ç–æ','–û–±—â–∏–π –ß–∏—Å—Ç—ã–º–∏'
      ],
      ...data.map(r => ([
        r.id, r.date, r.timestamp, r.operator, r.anketa, r.shift,
        r.sources?.onlyfans?.gross ?? 0, r.sources?.onlyfans?.percent ?? 0, r.sources?.onlyfans?.operatorShare ?? 0,
        r.sources?.crypto?.gross ?? 0,   r.sources?.crypto?.percent ?? 0,   r.sources?.crypto?.operatorShare ?? 0,
        r.sources?.paypal?.gross ?? 0,   r.sources?.paypal?.percent ?? 0,   r.sources?.paypal?.operatorShare ?? 0,
        r.total?.gross ?? 0, r.total?.operatorShare ?? 0
      ]))
    ];

    try {
      await ensureSheetStructure();
      await window.gapi.client.sheets.spreadsheets.values.update({
        spreadsheetId: SPREADSHEET_ID,
        range: '–î–æ—Ö–æ–¥—ã!A1',
        valueInputOption: 'RAW',
        resource: { values }
      });
      showSuccess('‚úì –ó–∞–ø–∏—Å–∞–Ω–æ –≤ Google Sheets');
    } catch (e) {
      console.error(e);
      showError('–û—à–∏–±–∫–∞ –∑–∞–ø–∏—Å–∏ –≤ —Ç–∞–±–ª–∏—Ü—É. –ü—Ä–æ–≤–µ—Ä—å Share ‚Üí Editor.');
    }
  }

  // =========================
  // TABS (—Ñ–∏–∫—Å: event –ø–µ—Ä–µ–¥–∞—ë–º)
  // =========================
  function switchTab(tabName, ev) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    if (ev && ev.target) ev.target.classList.add('active');

    if (tabName === 'dashboard') generateDashboard();
    else if (tabName === 'reports') generateOperatorReport(allOperators[0]);
    else if (tabName === 'advances') updateAdvancesUI();
    else if (tabName === 'penalties') updatePenaltiesUI();
    else if (tabName === 'sheets') showSpreadsheetViewer();
  }

  function showSpreadsheetViewer() {
    const container = document.getElementById('sheetsContainer');
    container.innerHTML = `
      <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:12px;">
        <button class="btn-secondary" onclick="openSheetInNewTab()">üîó –û—Ç–∫—Ä—ã—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
        <button class="btn-secondary" onclick="pullIncomeFromSheets().then(()=>{updateEditTab();showSuccess('‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ Sheets')})">‚¨áÔ∏è Pull</button>
        <button class="btn-secondary" onclick="pushIncomeToSheets()">‚¨ÜÔ∏è Push</button>
      </div>
      <iframe
        src="https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit?usp=sharing"
        width="100%"
        height="650"
        style="border: 1px solid rgba(99, 102, 241, 0.2); border-radius: 8px;"
      ></iframe>
    `;
  }

  function openSheetInNewTab() {
    window.open(`https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/edit`, '_blank');
  }

  // =========================
  // Helpers UI
  // =========================
  function updateOperatorSelects() {
    const selects = document.querySelectorAll('#operator, #advanceOperator, #penaltyOperator');
    selects.forEach(select => {
      const current = select.value;
      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>' +
        allOperators.map(op => `<option value="${op}">${op}</option>`).join('');
      select.value = current;
    });
  }

  function updateAnketaSelector() {
    const container = document.getElementById('anketaSelector');
    container.innerHTML = allAnkety.map(anketa => `
      <div class="anketa-checkbox">
        <input type="checkbox" id="anketa-${anketa}" value="${anketa}" onchange="updateAnketaInputs()">
        <label for="anketa-${anketa}">${anketa}</label>
      </div>
    `).join('');
    updateAnketaInputs();
  }

  function updateAnketaInputs() {
    const container = document.getElementById('anketaInputsContainer');
    const selected = Array.from(document.querySelectorAll('.anketa-checkbox input:checked')).map(el => el.value);
    if (selected.length === 0) { container.innerHTML = ''; return; }

    container.innerHTML = selected.map(anketa => `
      <div class="anketa-inputs">
        <div class="anketa-inputs-header">üì± ${anketa}</div>
        <div class="income-grid">
          <div class="income-group"><span class="income-label">OnlyFans</span>
            <input type="number" id="income-${anketa}-onlyfans" placeholder="0.00" step="0.01" min="0">
          </div>
          <div class="income-group"><span class="income-label">–ö—Ä–∏–ø—Ç–æ</span>
            <input type="number" id="income-${anketa}-crypto" placeholder="0.00" step="0.01" min="0">
          </div>
          <div class="income-group"><span class="income-label">PayPal</span>
            <input type="number" id="income-${anketa}-paypal" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>
      </div>
    `).join('');
  }

  // =========================
  // Income CRUD (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ)
  // =========================
  function addIncome() {
    const operator = document.getElementById('operator').value;
    const shift = document.getElementById('shift').value;
    const selected = Array.from(document.querySelectorAll('.anketa-checkbox input:checked')).map(el => el.value);

    if (!operator || !shift || selected.length === 0) {
      showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
      return;
    }

    const onlyFansPercent = parseFloat(document.getElementById('onlyfansPercent').value);
    const cryptoPercent = parseFloat(document.getElementById('cryptoPercent').value);
    const paypalPercent = parseFloat(document.getElementById('paypalPercent').value);

    let hasData = false;
    const records = [];

    selected.forEach(anketa => {
      const onlyfans = parseFloat(document.getElementById(`income-${anketa}-onlyfans`)?.value) || 0;
      const crypto = parseFloat(document.getElementById(`income-${anketa}-crypto`)?.value) || 0;
      const paypal = parseFloat(document.getElementById(`income-${anketa}-paypal`)?.value) || 0;

      const total = onlyfans + crypto + paypal;
      if (total > 0) hasData = true;

      records.push({
        id: String(Date.now() + Math.random()),
        operator, anketa, shift,
        date: new Date().toISOString().split('T')[0],
        day: new Date().getDate(),
        timestamp: new Date().toLocaleString('ru-RU'),
        sources: {
          onlyfans: { gross: onlyfans, percent: onlyFansPercent, operatorShare: onlyfans * (onlyFansPercent / 100) },
          crypto:   { gross: crypto,   percent: cryptoPercent,   operatorShare: crypto * (cryptoPercent / 100) },
          paypal:   { gross: paypal,   percent: paypalPercent,   operatorShare: paypal * (paypalPercent / 100) }
        },
        total: { gross: total, operatorShare: (onlyfans*onlyFansPercent/100) + (crypto*cryptoPercent/100) + (paypal*paypalPercent/100) }
      });
    });

    if (!hasData) { showError('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ—Ö–æ–¥!'); return; }

    let data = JSON.parse(localStorage.getItem('incomeData') || '[]');
    records.forEach(r => data.push(r));
    localStorage.setItem('incomeData', JSON.stringify(data));

    showSuccess(`‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ ${records.length} –∑–∞–ø–∏—Å–µ–π!`);
    updateEditTab();

    if (userLoggedIn) pushIncomeToSheets();

    document.getElementById('operator').value = '';
    document.getElementById('shift').value = '';
    updateAnketaSelector();
  }

  function updateEditTab() {
    const data = JSON.parse(localStorage.getItem('incomeData') || '[]');
    const container = document.getElementById('editContainer');
    if (!container) return;

    if (data.length === 0) {
      container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 32px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
      return;
    }

    container.innerHTML = data.slice().reverse().map((record) => `
      <div class="transaction-row">
        <div>
          <div style="font-weight: 600; font-size: 12px;">${record.operator} - ${record.anketa}</div>
          <div style="font-size: 10px; color: var(--text-secondary);">${record.shift} | ${record.date}</div>
        </div>
        <div style="font-weight: 700; color: var(--success); font-family: 'Space Mono'; font-size: 12px;">
          $${Number(record.total.operatorShare || 0).toFixed(2)}
        </div>
      </div>
    `).join('');
  }

  // =========================
  // –ó–∞–≥–ª—É—à–∫–∏ –ø–æ–¥ —Ç–≤–æ–π –±–æ–ª—å—à–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª
  // (—á—Ç–æ–±—ã —Ñ–∞–π–ª —Ç–æ—á–Ω–æ –Ω–µ –ø–∞–¥–∞–ª, –¥–∞–∂–µ –µ—Å–ª–∏ —á–∞—Å—Ç–∏ –Ω–µ –≤—Å—Ç–∞–≤–∏–ª)
  // =========================
  function generateDashboard() {}
  function generateOperatorReport() {}
  function updateReportsOperatorList() {}
  function updateAdvanceSelector() {}
  function updatePenaltySelector() {}
  function updateSettingsUI() {}
  function updateAdvancesUI() {}
  function updatePenaltiesUI() {}

  // =========================
  // Toasts
  // =========================
  function showError(message) {
    const msg = document.createElement('div');
    msg.className = 'success-message';
    msg.textContent = '‚ùå ' + message;
    msg.style.background = 'var(--danger)';
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 3500);
  }
  function showSuccess(message) {
    const msg = document.createElement('div');
    msg.className = 'success-message';
    msg.textContent = message;
    document.body.appendChild(msg);
    setTimeout(() => msg.remove(), 2500);
  }

  window.addEventListener('load', init);
</script>

</body>
</html>
