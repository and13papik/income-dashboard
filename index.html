<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Income Dashboard Pro - Cloud Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #6366f1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --bg: #0f172a;
            --text: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border: #475569;
        }
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #1a1f3a 100%);
            color: var(--text);
            min-height: 100vh;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        .container {
            position: relative;
            z-index: 1;
            max-width: 1800px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 40px;
            flex-wrap: wrap;
            gap: 20px;
        }
        header h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary) 0%, var(--success) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .header-right {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }
        .date-display {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 12px 20px;
            text-align: center;
        }
        .date-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--primary);
            font-family: 'Space Mono';
        }
        .sync-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .status-badge {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            border: 1px solid rgba(239, 68, 68, 0.5);
            animation: pulse 2s infinite;
        }
        .status-badge.connected {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success);
            border-color: rgba(16, 185, 129, 0.5);
            animation: none;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .tabs {
            display: flex;
            gap: 12px;
            margin-bottom: 30px;
            background: rgba(30, 41, 59, 0.8);
            padding: 12px;
            border-radius: 12px;
            flex-wrap: wrap;
            overflow-x: auto;
        }
        .tab-btn {
            padding: 10px 16px;
            background: transparent;
            border: 2px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            font-size: 11px;
            white-space: nowrap;
        }
        .tab-btn.active {
            background: rgba(99, 102, 241, 0.2);
            border-color: var(--primary);
            color: var(--primary);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .card {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 16px;
            padding: 32px;
            max-height: 85vh;
            overflow-y: auto;
        }
        .card-title { font-size: 18px; font-weight: 700; margin-bottom: 20px; }
        .form-group { margin-bottom: 18px; }
        label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        select, input {
            width: 100%;
            padding: 10px 14px;
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 13px;
            font-family: 'Inter', sans-serif;
        }
        select:focus, input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }
        .anketa-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        .anketa-checkbox {
            display: flex;
            align-items: center;
            padding: 8px;
            background: rgba(99, 102, 241, 0.05);
            border: 2px solid rgba(99, 102, 241, 0.2);
            border-radius: 6px;
            cursor: pointer;
        }
        .anketa-checkbox:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }
        .anketa-checkbox input { width: 16px; height: 16px; margin-right: 6px; accent-color: var(--primary); }
        .anketa-checkbox label { margin: 0; font-size: 11px; cursor: pointer; }
        .anketa-inputs {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .anketa-inputs-header {
            font-weight: 600;
            font-size: 12px;
            color: var(--primary);
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(99, 102, 241, 0.2);
            margin-bottom: 12px;
        }
        .income-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: 10px;
        }
        .income-group { position: relative; }
        .income-label {
            position: absolute;
            left: 10px;
            top: 8px;
            font-size: 8px;
            font-weight: 700;
            color: var(--primary);
            text-transform: uppercase;
            background: rgba(30, 41, 59, 0.8);
            padding: 0 2px;
        }
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
            width: 100%;
            margin-top: 16px;
        }
        .btn-primary:hover {
            background: #4f46e5;
            transform: translateY(-2px);
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            width: auto;
            padding: 8px 12px;
            font-size: 10px;
        }
        .btn-secondary:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary);
        }
        .success-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            z-index: 1000;
            animation: slideInRight 0.5s ease-out;
        }
        @keyframes slideInRight {
            from { opacity: 0; transform: translateX(400px); }
            to { opacity: 1; transform: translateX(0); }
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            overflow-y: auto;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: rgba(30, 41, 59, 0.95);
            border: 1px solid rgba(71, 85, 105, 0.3);
            border-radius: 12px;
            padding: 28px;
            max-width: 600px;
            width: 90%;
            margin: 20px;
        }
        .modal-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 18px;
            display: flex;
            justify-content: space-between;
        }
        .close-modal { background: transparent; border: none; color: var(--text); font-size: 20px; cursor: pointer; }
        .report-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            padding: 14px;
            text-align: center;
        }
        .stat-label { font-size: 10px; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600; }
        .stat-value { font-size: 18px; font-weight: 700; color: var(--success); font-family: 'Space Mono'; }
        .report-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
            font-size: 11px;
        }
        .report-table th {
            background: rgba(99, 102, 241, 0.1);
            padding: 8px;
            text-align: left;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 2px solid rgba(99, 102, 241, 0.2);
        }
        .report-table td { padding: 8px; border-bottom: 1px solid rgba(99, 102, 241, 0.1); }
        .section-title { font-size: 13px; font-weight: 700; margin-top: 24px; margin-bottom: 10px; color: var(--primary); }
        .transaction-row {
            background: rgba(99, 102, 241, 0.05);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
        }
        .setup-info {
            background: rgba(99, 102, 241, 0.1);
            border: 2px dashed var(--primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: var(--text-secondary);
        }
        .setup-info h2 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 16px;
        }
        .setup-info input {
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üí∞ Income Dashboard Pro</h1>
            <div class="header-right">
                <div class="date-display">
                    <div class="date-value" id="currentDate"></div>
                </div>
                <div class="sync-controls">
                    <div class="status-badge" id="syncStatus">üî¥ Not Connected</div>
                </div>
            </div>
        </header>

        <div class="tabs">
            <button class="tab-btn active" onclick="switchTab('setup')">üîß Setup</button>
            <button class="tab-btn" onclick="switchTab('add-income')">‚ûï –î–æ–±–∞–≤–∏—Ç—å</button>
            <button class="tab-btn" onclick="switchTab('edit-income')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="tab-btn" onclick="switchTab('dashboard')">üìä Dashboard</button>
            <button class="tab-btn" onclick="switchTab('reports')">üìà –ü–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º</button>
            <button class="tab-btn" onclick="switchTab('advances')">üí∞ –ê–≤–∞–Ω—Å—ã/–ó–∞—Ä–ø–ª–∞—Ç–∞</button>
            <button class="tab-btn" onclick="switchTab('penalties')">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</button>
            <button class="tab-btn" onclick="switchTab('settings')">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 0: SETUP -->
        <div id="setup" class="tab-content active">
            <div class="card">
                <div class="card-title">üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Sheets –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏</div>
                <div class="setup-info">
                    <h2>üìä –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Google Sheets</h2>
                    <p style="margin-bottom: 16px;">–í—Å—Ç–∞–≤—å—Ç–µ URL –≤–∞—à–µ–π Google Sheets —Ç–∞–±–ª–∏—Ü—ã –∏ ID Google Apps Script</p>
                    
                    <div class="form-group">
                        <label>Spreadsheet ID (–∏–∑ URL Google Sheets)</label>
                        <input type="text" id="spreadsheetId" placeholder="1a2b3c4d5e6f7g8h9...">
                        <small style="color: var(--text-secondary); font-size: 10px; margin-top: 6px; display: block;">
                            –ù–∞–π—Ç–∏ –≤ URL: docs.google.com/spreadsheets/d/<strong>–≠–¢–û–¢_ID</strong>/edit
                        </small>
                    </div>

                    <div class="form-group">
                        <label>Google Apps Script Deploy URL</label>
                        <input type="text" id="scriptUrl" placeholder="https://script.google.com/macros/d/...">
                        <small style="color: var(--text-secondary); font-size: 10px; margin-top: 6px; display: block;">
                            URL —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –≤–∞—à–µ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
                        </small>
                    </div>

                    <button class="btn-primary" onclick="saveConnectionSettings()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <p style="margin-top: 20px; font-size: 11px; color: var(--text-secondary);">
                        ‚ÑπÔ∏è <a href="https://docs.google.com/document/d/1..." target="_blank" style="color: var(--primary);">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–æ–ª—É—á–µ–Ω–∏—é ID</a>
                    </p>
                </div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 1: –î–û–ë–ê–í–õ–ï–ù–ò–ï -->
        <div id="add-income" class="tab-content">
            <div class="card">
                <div class="card-title">üìù –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</div>

                <div class="form-group">
                    <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
                    <select id="operator" onchange="updateAnketaSelector()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–°–º–µ–Ω–∞ *</label>
                    <select id="shift">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        <option value="–£—Ç—Ä–æ (08:00-14:00)">–£—Ç—Ä–æ (08:00-14:00)</option>
                        <option value="–î–µ–Ω—å (14:00-20:00)">–î–µ–Ω—å (14:00-20:00)</option>
                        <option value="–í–µ—á–µ—Ä (20:00-02:00)">–í–µ—á–µ—Ä (20:00-02:00)</option>
                        <option value="–ù–æ—á—å (02:00-08:00)">–ù–æ—á—å (02:00-08:00)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–ê–Ω–∫–µ—Ç—ã *</label>
                    <div class="anketa-selector" id="anketaSelector"></div>
                </div>

                <div id="anketaInputsContainer"></div>

                <div class="form-group">
                    <label>% –û–ø–µ—Ä–∞—Ç–æ—Ä—É</label>
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                        <div>
                            <small style="color: var(--text-secondary); font-size: 10px;">OnlyFans</small>
                            <input type="number" id="onlyfansPercent" value="20" min="0" max="100" step="1">
                        </div>
                        <div>
                            <small style="color: var(--text-secondary); font-size: 10px;">–ö—Ä–∏–ø—Ç–æ</small>
                            <input type="number" id="cryptoPercent" value="20" min="0" max="100" step="1">
                        </div>
                        <div>
                            <small style="color: var(--text-secondary); font-size: 10px;">PayPal</small>
                            <input type="number" id="paypalPercent" value="15" min="0" max="100" step="1">
                        </div>
                    </div>
                </div>

                <button class="btn-primary" onclick="addIncome()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥</button>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 2: –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï -->
        <div id="edit-income" class="tab-content">
            <div class="card">
                <div class="card-title">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Ö–æ–¥—ã</div>
                <div id="editContainer"></div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 3: DASHBOARD -->
        <div id="dashboard" class="tab-content">
            <div class="card">
                <div class="card-title">üìä –û–±—â–∏–π Dashboard</div>
                <div id="dashboardContent"></div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 4: –ü–û –û–ü–ï–†–ê–¢–û–†–ê–ú -->
        <div id="reports" class="tab-content">
            <div style="display: grid; grid-template-columns: 1fr 2fr; gap: 24px;">
                <div style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 24px; max-height: 85vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 10px; font-size: 13px;">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
                    <div class="operator-list" id="operatorListReport"></div>
                </div>
                <div class="report-content" id="reportContent" style="background: rgba(30, 41, 59, 0.8); border: 1px solid rgba(71, 85, 105, 0.3); border-radius: 12px; padding: 24px; max-height: 85vh; overflow-y: auto;"></div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 5: –ê–í–ê–ù–°–´ –ò –ó–ê–†–ü–õ–ê–¢–ê -->
        <div id="advances" class="tab-content">
            <div class="card">
                <div class="card-title">üí∞ –ê–≤–∞–Ω—Å—ã –∏ –ó–∞—Ä–ø–ª–∞—Ç–∞</div>

                <div class="form-group">
                    <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
                    <select id="advanceOperator" onchange="updateAdvancesUI()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–¢–∏–ø –≤—ã–ø–ª–∞—Ç—ã *</label>
                    <select id="paymentType">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                        <option value="advance">üí∞ –ê–≤–∞–Ω—Å</option>
                        <option value="salary">üíµ –ó–∞—Ä–ø–ª–∞—Ç–∞</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–°—É–º–º–∞ *</label>
                    <input type="number" id="advanceAmount" placeholder="0.00" step="0.01" min="0">
                </div>

                <button class="btn-primary" onclick="addAdvance()">+ –í—ã–¥–∞—Ç—å</button>

                <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è</div>
                <div id="advancesHistory"></div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 6: –®–¢–†–ê–§–´ -->
        <div id="penalties" class="tab-content">
            <div class="card">
                <div class="card-title">‚ö†Ô∏è –®—Ç—Ä–∞—Ñ—ã</div>

                <div class="form-group">
                    <label>–û–ø–µ—Ä–∞—Ç–æ—Ä *</label>
                    <select id="penaltyOperator" onchange="updatePenaltiesUI()">
                        <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>–°—É–º–º–∞ —à—Ç—Ä–∞—Ñ–∞ *</label>
                    <input type="number" id="penaltyAmount" placeholder="0.00" step="0.01" min="0">
                </div>

                <div class="form-group">
                    <label>–ü—Ä–∏—á–∏–Ω–∞</label>
                    <input type="text" id="penaltyReason" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ —à—Ç—Ä–∞—Ñ–∞">
                </div>

                <button class="btn-primary" onclick="addPenalty()">‚ö†Ô∏è –î–æ–±–∞–≤–∏—Ç—å —à—Ç—Ä–∞—Ñ</button>

                <div class="section-title">–ò—Å—Ç–æ—Ä–∏—è</div>
                <div id="penaltiesHistory"></div>
            </div>
        </div>

        <!-- –í–ö–õ–ê–î–ö–ê 7: –ù–ê–°–¢–†–û–ô–ö–ò -->
        <div id="settings" class="tab-content">
            <div class="card">
                <div class="card-title">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>

                <h3 style="margin-top: 16px; margin-bottom: 10px; font-size: 13px;">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
                <div id="operatorsList"></div>
                <button class="btn-primary" onclick="openModal('addOperatorModal')" style="width: auto; margin-top: 10px;">+ –û–ø–µ—Ä–∞—Ç–æ—Ä</button>

                <h3 style="margin-top: 24px; margin-bottom: 10px; font-size: 13px;">–ê–Ω–∫–µ—Ç—ã</h3>
                <div id="anketasList"></div>
                <button class="btn-primary" onclick="openModal('addAnketaModal')" style="width: auto; margin-top: 10px;">+ –ê–Ω–∫–µ—Ç–∞</button>

                <h3 style="margin-top: 24px; margin-bottom: 10px; font-size: 13px;">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</h3>
                <div id="adminList"></div>
                <button class="btn-primary" onclick="openModal('addAdminModal')" style="width: auto; margin-top: 10px;">+ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</button>
            </div>
        </div>
    </div>

    <!-- –ú–û–î–ê–õ–´ -->
    <div id="addOperatorModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                –î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                <button class="close-modal" onclick="closeModal('addOperatorModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>–ò–º—è</label>
                <input type="text" id="newOperatorName">
            </div>
            <button class="btn-primary" onclick="addOperator()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="addAnketaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                –î–æ–±–∞–≤–∏—Ç—å –∞–Ω–∫–µ—Ç—É
                <button class="close-modal" onclick="closeModal('addAnketaModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>–ò–º—è</label>
                <input type="text" id="newAnketaName">
            </div>
            <button class="btn-primary" onclick="addAnketa()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="addAdminModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                –î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                <button class="close-modal" onclick="closeModal('addAdminModal')">√ó</button>
            </div>
            <div class="form-group">
                <label>–ò–º—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞</label>
                <input type="text" id="newAdminName">
            </div>
            <button class="btn-primary" onclick="addAdmin()">–î–æ–±–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                <button class="close-modal" onclick="closeModal('editModal')">√ó</button>
            </div>
            <div id="editFormContent"></div>
            <button class="btn-primary" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>

    <script>
        // ===== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï =====
        let allAnkety = ["Succuba", "Mommy", "Nola", "Lust", "Mermaid", "Stacy", "Fitness", "Caitlyn"];
        let allOperators = ["Operator 1", "Operator 2", "Operator 3"];
        let allAdmins = ["Admin 1", "Admin 2"];
        let spreadsheetId = localStorage.getItem('spreadsheetId') || '';
        let scriptUrl = localStorage.getItem('scriptUrl') || '';
        const ADMIN_PERCENT = 8;
        
        // –ö—ç—à –¥–∞–Ω–Ω—ã—Ö
        let incomeData = [];
        let advancesData = {};
        let penaltiesData = {};

        function init() {
            updateDate();
            loadAllData();
            updateOperatorSelects();
            updateSettingsUI();
            updateEditTab();
            updateReportsOperatorList();
            updateAdvanceSelector();
            updatePenaltySelector();
            setInterval(updateDate, 1000);
        }

        function updateDate() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ru-RU', options);
        }

        function saveConnectionSettings() {
            const spreadsheetId = document.getElementById('spreadsheetId').value.trim();
            const scriptUrl = document.getElementById('scriptUrl').value.trim();

            if (!spreadsheetId || !scriptUrl) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±–∞ –ø–æ–ª—è!');
                return;
            }

            localStorage.setItem('spreadsheetId', spreadsheetId);
            localStorage.setItem('scriptUrl', scriptUrl);

            window.spreadsheetId = spreadsheetId;
            window.scriptUrl = scriptUrl;

            checkConnection();
            loadAllData();
            showSuccess('‚úì –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!');
        }

        function checkConnection() {
            const connected = localStorage.getItem('spreadsheetId') && localStorage.getItem('scriptUrl');
            const badge = document.getElementById('syncStatus');
            
            if (connected) {
                badge.textContent = 'üü¢ Connected';
                badge.classList.add('connected');
            } else {
                badge.textContent = 'üî¥ Not Connected';
                badge.classList.remove('connected');
            }
        }

        async function loadAllData() {
            if (!localStorage.getItem('spreadsheetId')) {
                showError('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Google Sheets!');
                return;
            }

            try {
                const response = await fetch(`${localStorage.getItem('scriptUrl')}?action=getAllData`);
                const result = await response.json();

                if (result.incomes) incomeData = result.incomes;
                if (result.operators) allOperators = result.operators;
                if (result.ankety) allAnkety = result.ankety;
                if (result.admins) allAdmins = result.admins;

                updateOperatorSelects();
                updateSettingsUI();
                updateEditTab();
                updateReportsOperatorList();
                updateAnketaSelector();
            } catch (error) {
                console.log('Loading data...');
            }
        }

        async function sendToSheets(action, data) {
            const scriptUrl = localStorage.getItem('scriptUrl');
            if (!scriptUrl) return false;

            try {
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: action,
                        data: data,
                        timestamp: new Date().toISOString()
                    })
                });
                return true;
            } catch (error) {
                console.error('Error sending to Sheets:', error);
                return false;
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');

            if (tabName === 'dashboard') generateDashboard();
            else if (tabName === 'reports') {
                if (allOperators.length > 0) generateOperatorReport(allOperators[0]);
            }
            else if (tabName === 'advances') updateAdvancesUI();
            else if (tabName === 'penalties') updatePenaltiesUI();
        }

        function updateOperatorSelects() {
            const selects = document.querySelectorAll('#operator, #advanceOperator, #penaltyOperator');
            selects.forEach(select => {
                const current = select.value;
                select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>' + 
                    allOperators.map(op => `<option value="${op}">${op}</option>`).join('');
                select.value = current;
            });
        }

        function updateAnketaSelector() {
            const container = document.getElementById('anketaSelector');
            container.innerHTML = allAnkety.map(anketa => `
                <div class="anketa-checkbox">
                    <input type="checkbox" id="anketa-${anketa}" value="${anketa}" onchange="updateAnketaInputs()">
                    <label for="anketa-${anketa}">${anketa}</label>
                </div>
            `).join('');
            updateAnketaInputs();
        }

        function updateAnketaInputs() {
            const container = document.getElementById('anketaInputsContainer');
            const selected = Array.from(document.querySelectorAll('.anketa-checkbox input:checked')).map(el => el.value);

            if (selected.length === 0) {
                container.innerHTML = '';
                return;
            }

            container.innerHTML = selected.map(anketa => `
                <div class="anketa-inputs">
                    <div class="anketa-inputs-header">üì± ${anketa}</div>
                    <div class="income-grid">
                        <div class="income-group">
                            <span class="income-label">OnlyFans</span>
                            <input type="number" id="income-${anketa}-onlyfans" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="income-group">
                            <span class="income-label">–ö—Ä–∏–ø—Ç–æ</span>
                            <input type="number" id="income-${anketa}-crypto" placeholder="0.00" step="0.01" min="0">
                        </div>
                        <div class="income-group">
                            <span class="income-label">PayPal</span>
                            <input type="number" id="income-${anketa}-paypal" placeholder="0.00" step="0.01" min="0">
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function addIncome() {
            const operator = document.getElementById('operator').value;
            const shift = document.getElementById('shift').value;
            const selected = Array.from(document.querySelectorAll('.anketa-checkbox input:checked')).map(el => el.value);

            if (!operator || !shift || selected.length === 0) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const onlyFansPercent = parseFloat(document.getElementById('onlyfansPercent').value);
            const cryptoPercent = parseFloat(document.getElementById('cryptoPercent').value);
            const paypalPercent = parseFloat(document.getElementById('paypalPercent').value);

            let hasData = false;
            const records = [];

            selected.forEach(anketa => {
                const onlyfans = parseFloat(document.getElementById(`income-${anketa}-onlyfans`)?.value) || 0;
                const crypto = parseFloat(document.getElementById(`income-${anketa}-crypto`)?.value) || 0;
                const paypal = parseFloat(document.getElementById(`income-${anketa}-paypal`)?.value) || 0;

                const total = onlyfans + crypto + paypal;
                if (total > 0) hasData = true;

                const record = {
                    id: Date.now() + Math.random(),
                    operator,
                    anketa,
                    shift,
                    date: new Date().toISOString().split('T')[0],
                    day: new Date().getDate(),
                    timestamp: new Date().toLocaleString('ru-RU'),
                    sources: {
                        onlyfans: { gross: onlyfans, percent: onlyFansPercent, operatorShare: onlyfans * (onlyFansPercent / 100) },
                        crypto: { gross: crypto, percent: cryptoPercent, operatorShare: crypto * (cryptoPercent / 100) },
                        paypal: { gross: paypal, percent: paypalPercent, operatorShare: paypal * (paypalPercent / 100) }
                    },
                    total: {
                        gross: total,
                        operatorShare: (onlyfans * onlyFansPercent / 100) + (crypto * cryptoPercent / 100) + (paypal * paypalPercent / 100)
                    }
                };

                records.push(record);
            });

            if (!hasData) {
                showError('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –¥–æ—Ö–æ–¥!');
                return;
            }

            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Google Sheets
            for (let record of records) {
                await sendToSheets('addIncome', record);
                incomeData.push(record);
            }

            showSuccess(`‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ ${records.length} –∑–∞–ø–∏—Å–µ–π!`);
            document.getElementById('operator').value = '';
            document.getElementById('shift').value = '';
            updateAnketaSelector();
            updateEditTab();
            loadAllData();
        }

        function updateEditTab() {
            const container = document.getElementById('editContainer');

            if (incomeData.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 32px;">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</p>';
                return;
            }

            container.innerHTML = incomeData.slice().reverse().map((record) => `
                <div class="transaction-row">
                    <div>
                        <div style="font-weight: 600; font-size: 12px;">${record.operator} - ${record.anketa}</div>
                        <div style="font-size: 10px; color: var(--text-secondary);">${record.shift} | ${record.date}</div>
                    </div>
                    <div style="font-weight: 700; color: var(--success); font-family: 'Space Mono'; font-size: 12px;">$${record.total.operatorShare.toFixed(2)}</div>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn-secondary" onclick="openEditModal('${record.id}')">‚úèÔ∏è</button>
                        <button class="btn-secondary" onclick="deleteIncome('${record.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `).join('');
        }

        function openEditModal(id) {
            const record = incomeData.find(r => r.id == id);
            if (!record) return;

            const formContent = `
                <div class="form-group">
                    <label>OnlyFans</label>
                    <input type="number" id="edit-onlyfans" value="${record.sources.onlyfans.gross}" step="0.01">
                </div>
                <div class="form-group">
                    <label>–ö—Ä–∏–ø—Ç–æ</label>
                    <input type="number" id="edit-crypto" value="${record.sources.crypto.gross}" step="0.01">
                </div>
                <div class="form-group">
                    <label>PayPal</label>
                    <input type="number" id="edit-paypal" value="${record.sources.paypal.gross}" step="0.01">
                </div>
            `;

            document.getElementById('editFormContent').innerHTML = formContent;
            window.currentEditId = id;
            openModal('editModal');
        }

        async function saveEdit() {
            const onlyfans = parseFloat(document.getElementById('edit-onlyfans').value) || 0;
            const crypto = parseFloat(document.getElementById('edit-crypto').value) || 0;
            const paypal = parseFloat(document.getElementById('edit-paypal').value) || 0;

            const recordIndex = incomeData.findIndex(r => r.id == window.currentEditId);

            if (recordIndex === -1) return;

            const record = incomeData[recordIndex];
            
            record.sources.onlyfans.gross = onlyfans;
            record.sources.onlyfans.operatorShare = onlyfans * (record.sources.onlyfans.percent / 100);

            record.sources.crypto.gross = crypto;
            record.sources.crypto.operatorShare = crypto * (record.sources.crypto.percent / 100);

            record.sources.paypal.gross = paypal;
            record.sources.paypal.operatorShare = paypal * (record.sources.paypal.percent / 100);

            record.total.gross = onlyfans + crypto + paypal;
            record.total.operatorShare = record.sources.onlyfans.operatorShare + record.sources.crypto.operatorShare + record.sources.paypal.operatorShare;

            incomeData[recordIndex] = record;
            
            await sendToSheets('updateIncome', record);
            closeModal('editModal');
            updateEditTab();
            showSuccess('‚úì –û–±–Ω–æ–≤–ª–µ–Ω–æ!');
        }

        async function deleteIncome(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            incomeData = incomeData.filter(r => r.id != id);
            await sendToSheets('deleteIncome', { id: id });
            updateEditTab();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        function generateDashboard() {
            let totalGross = 0;
            let totalOperatorShare = 0;
            const byAnketa = {};
            const bySource = { onlyfans: { total: 0, byAnketa: {} }, crypto: { total: 0, byAnketa: {} }, paypal: { total: 0, byAnketa: {} } };

            incomeData.forEach(record => {
                totalGross += record.total.gross;
                totalOperatorShare += record.total.operatorShare;

                if (!byAnketa[record.anketa]) {
                    byAnketa[record.anketa] = { gross: 0, operatorShare: 0 };
                }
                byAnketa[record.anketa].gross += record.total.gross;
                byAnketa[record.anketa].operatorShare += record.total.operatorShare;

                bySource.onlyfans.total += record.sources.onlyfans.operatorShare;
                bySource.crypto.total += record.sources.crypto.operatorShare;
                bySource.paypal.total += record.sources.paypal.operatorShare;

                ['onlyfans', 'crypto', 'paypal'].forEach(source => {
                    if (!bySource[source].byAnketa[record.anketa]) {
                        bySource[source].byAnketa[record.anketa] = 0;
                    }
                    bySource[source].byAnketa[record.anketa] += record.sources[source].operatorShare;
                });
            });

            const adminShare = totalGross * (ADMIN_PERCENT / 100);

            let html = `
                <div class="report-grid">
                    <div class="stat-card">
                        <div class="stat-label">–ë—Ä—É—Ç—Ç–æ (–≤—Å–µ)</div>
                        <div class="stat-value">$${totalGross.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–û–ø–µ—Ä–∞—Ç–æ—Ä–∞–º</div>
                        <div class="stat-value">$${totalOperatorShare.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ê–¥–º–∏–Ω–∞–º (${ADMIN_PERCENT}%)</div>
                        <div class="stat-value" style="color: var(--warning);">$${adminShare.toFixed(2)}</div>
                    </div>
                </div>

                <div class="section-title">üë± –ü–æ –∞–Ω–∫–µ—Ç–∞–º (—á–∏—Å—Ç—ã–º–∏)</div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–ê–Ω–∫–µ—Ç–∞</th>
                            <th>–ë—Ä—É—Ç—Ç–æ</th>
                            <th>–û–ø–µ—Ä–∞—Ç–æ—Ä—É</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(byAnketa).map(([anketa, stats]) => `
                            <tr>
                                <td><strong>${anketa}</strong></td>
                                <td>$${stats.gross.toFixed(2)}</td>
                                <td><strong>$${stats.operatorShare.toFixed(2)}</strong></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('dashboardContent').innerHTML = html;
        }

        function updateReportsOperatorList() {
            const container = document.getElementById('operatorListReport');
            if (allOperators.length === 0) {
                container.innerHTML = '<p style="color: var(--text-secondary);">–î–æ–±–∞–≤—å—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</p>';
                return;
            }

            container.innerHTML = allOperators.map(op => `
                <div style="padding: 10px; background: rgba(99, 102, 241, 0.05); border: 2px solid transparent; border-radius: 6px; cursor: pointer; transition: all 0.3s ease; font-weight: 600; font-size: 13px; ${op === allOperators[0] ? 'background: rgba(99, 102, 241, 0.2); border-color: var(--primary); color: var(--primary);' : ''}" onclick="selectOperatorReport('${op}')">${op}</div>
            `).join('');
        }

        function selectOperatorReport(operator) {
            document.querySelectorAll('[onclick*="selectOperatorReport"]').forEach(el => {
                el.style.background = 'rgba(99, 102, 241, 0.05)';
                el.style.borderColor = 'transparent';
                el.style.color = 'var(--text)';
            });
            event.target.style.background = 'rgba(99, 102, 241, 0.2)';
            event.target.style.borderColor = 'var(--primary)';
            event.target.style.color = 'var(--primary)';
            generateOperatorReport(operator);
        }

        function generateOperatorReport(operator) {
            const operatorData = incomeData.filter(record => record.operator === operator);

            const byDay = {};
            const byAnketa = {};
            let totalGross = 0, totalOperatorShare = 0;

            operatorData.forEach(record => {
                const day = record.day;
                const anketa = record.anketa;

                if (!byDay[day]) byDay[day] = [];
                byDay[day].push(record);

                if (!byAnketa[anketa]) {
                    byAnketa[anketa] = { gross: 0, operatorShare: 0, sources: { onlyfans: 0, crypto: 0, paypal: 0 } };
                }

                byAnketa[anketa].gross += record.total.gross;
                byAnketa[anketa].operatorShare += record.total.operatorShare;
                byAnketa[anketa].sources.onlyfans += record.sources.onlyfans.operatorShare;
                byAnketa[anketa].sources.crypto += record.sources.crypto.operatorShare;
                byAnketa[anketa].sources.paypal += record.sources.paypal.operatorShare;

                totalGross += record.total.gross;
                totalOperatorShare += record.total.operatorShare;
            });

            let html = `
                <div class="card-title">üìä ${operator}</div>
                <div class="report-grid">
                    <div class="stat-card">
                        <div class="stat-label">–ë—Ä—É—Ç—Ç–æ</div>
                        <div class="stat-value">$${totalGross.toFixed(2)}</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">–ß–∏—Å—Ç—ã–º–∏</div>
                        <div class="stat-value">$${totalOperatorShare.toFixed(2)}</div>
                    </div>
                </div>

                <div class="section-title">üë± –ü–æ –∞–Ω–∫–µ—Ç–∞–º (—á–∏—Å—Ç—ã–º–∏)</div>
                <table class="report-table">
                    <thead>
                        <tr>
                            <th>–ê–Ω–∫–µ—Ç–∞</th>
                            <th>–ë—Ä—É—Ç—Ç–æ</th>
                            <th>–ß–∏—Å—Ç—ã–º–∏</th>
                            <th>OnlyFans</th>
                            <th>–ö—Ä–∏–ø—Ç–æ</th>
                            <th>PayPal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Object.entries(byAnketa).map(([anketa, stats]) => `
                            <tr>
                                <td><strong>${anketa}</strong></td>
                                <td>$${stats.gross.toFixed(2)}</td>
                                <td><strong>$${stats.operatorShare.toFixed(2)}</strong></td>
                                <td>$${stats.sources.onlyfans.toFixed(2)}</td>
                                <td>$${stats.sources.crypto.toFixed(2)}</td>
                                <td>$${stats.sources.paypal.toFixed(2)}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;

            document.getElementById('reportContent').innerHTML = html;
        }

        async function addAdvance() {
            const operator = document.getElementById('advanceOperator').value;
            const type = document.getElementById('paymentType').value;
            const amount = parseFloat(document.getElementById('advanceAmount').value);

            if (!operator || !type || amount <= 0) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!');
                return;
            }

            const payment = {
                id: Date.now(),
                operator,
                type,
                amount,
                date: new Date().toLocaleString('ru-RU')
            };

            if (!advancesData[operator]) advancesData[operator] = [];
            advancesData[operator].push(payment);

            await sendToSheets('addPayment', payment);

            document.getElementById('advanceAmount').value = '';
            document.getElementById('paymentType').value = '';
            updateAdvancesUI();
            showSuccess('‚úì –ó–∞–ø–∏—Å–∞–Ω–æ!');
        }

        function updateAdvanceSelector() {
            const select = document.getElementById('advanceOperator');
            const current = select.value;
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>' + 
                allOperators.map(op => `<option value="${op}">${op}</option>`).join('');
            select.value = current;
        }

        function updateAdvancesUI() {
            const operator = document.getElementById('advanceOperator').value;
            const history = document.getElementById('advancesHistory');

            if (!operator) {
                history.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>';
                return;
            }

            const payments = advancesData[operator] || [];
            const totalAdvances = payments.filter(p => p.type === 'advance').reduce((sum, p) => sum + p.amount, 0);
            const totalSalaries = payments.filter(p => p.type === 'salary').reduce((sum, p) => sum + p.amount, 0);

            history.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                    <div style="background: rgba(99, 102, 241, 0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">–ê–≤–∞–Ω—Å–æ–≤</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--warning); font-family: 'Space Mono';">$${totalAdvances.toFixed(2)}</div>
                    </div>
                    <div style="background: rgba(99, 102, 241, 0.1); border-radius: 8px; padding: 10px; text-align: center;">
                        <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">–ó–∞—Ä–ø–ª–∞—Ç</div>
                        <div style="font-size: 16px; font-weight: 700; color: var(--info); font-family: 'Space Mono';">$${totalSalaries.toFixed(2)}</div>
                    </div>
                </div>

                ${payments.slice().reverse().map(p => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; margin-bottom: 6px; font-size: 11px;">
                        <div>
                            <div style="color: ${p.type === 'advance' ? 'var(--warning)' : 'var(--info)'}; font-weight: 600;">${p.type === 'advance' ? 'üí∞' : 'üíµ'} ${p.type === 'advance' ? '–ê–≤–∞–Ω—Å' : '–ó–∞—Ä–ø–ª–∞—Ç–∞'}</div>
                            <div style="color: var(--text-secondary); font-size: 9px;">${p.date}</div>
                        </div>
                        <div style="font-weight: 700; color: ${p.type === 'advance' ? 'var(--warning)' : 'var(--info)'};">$${p.amount.toFixed(2)}</div>
                        <button class="btn-secondary" onclick="deleteAdvance('${operator}', ${p.id})">üóëÔ∏è</button>
                    </div>
                `).join('')}
            `;
        }

        async function deleteAdvance(operator, id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            if (advancesData[operator]) {
                advancesData[operator] = advancesData[operator].filter(p => p.id !== id);
            }
            await sendToSheets('deletePayment', { id: id });
            updateAdvancesUI();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        async function addPenalty() {
            const operator = document.getElementById('penaltyOperator').value;
            const amount = parseFloat(document.getElementById('penaltyAmount').value);
            const reason = document.getElementById('penaltyReason').value;

            if (!operator || amount <= 0) {
                showError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è!');
                return;
            }

            const penalty = {
                id: Date.now(),
                operator,
                amount,
                reason: reason || '–®—Ç—Ä–∞—Ñ',
                date: new Date().toLocaleString('ru-RU')
            };

            if (!penaltiesData[operator]) penaltiesData[operator] = [];
            penaltiesData[operator].push(penalty);

            await sendToSheets('addPenalty', penalty);

            document.getElementById('penaltyAmount').value = '';
            document.getElementById('penaltyReason').value = '';
            updatePenaltiesUI();
            showSuccess('‚úì –®—Ç—Ä–∞—Ñ –¥–æ–±–∞–≤–ª–µ–Ω!');
        }

        function updatePenaltySelector() {
            const select = document.getElementById('penaltyOperator');
            const current = select.value;
            select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ --</option>' + 
                allOperators.map(op => `<option value="${op}">${op}</option>`).join('');
            select.value = current;
        }

        function updatePenaltiesUI() {
            const operator = document.getElementById('penaltyOperator').value;
            const history = document.getElementById('penaltiesHistory');

            if (!operator) {
                history.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</p>';
                return;
            }

            const penalties = penaltiesData[operator] || [];
            const totalPenalties = penalties.reduce((sum, p) => sum + p.amount, 0);

            history.innerHTML = `
                <div style="background: rgba(99, 102, 241, 0.1); border-radius: 8px; padding: 10px; margin-bottom: 12px; text-align: center;">
                    <div style="font-size: 10px; color: var(--text-secondary); margin-bottom: 4px;">–í—Å–µ–≥–æ —à—Ç—Ä–∞—Ñ–æ–≤</div>
                    <div style="font-size: 16px; font-weight: 700; color: var(--danger); font-family: 'Space Mono';">-$${totalPenalties.toFixed(2)}</div>
                </div>

                ${penalties.slice().reverse().map(p => `
                    <div style="display: flex; justify-content: space-between; padding: 8px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; margin-bottom: 6px; font-size: 11px;">
                        <div>
                            <div style="color: var(--danger); font-weight: 600;">‚ö†Ô∏è ${p.reason}</div>
                            <div style="color: var(--text-secondary); font-size: 9px;">${p.date}</div>
                        </div>
                        <div style="font-weight: 700; color: var(--danger);">-$${p.amount.toFixed(2)}</div>
                        <button class="btn-secondary" onclick="deletePenalty('${operator}', ${p.id})">üóëÔ∏è</button>
                    </div>
                `).join('')}
            `;
        }

        async function deletePenalty(operator, id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å?')) return;
            if (penaltiesData[operator]) {
                penaltiesData[operator] = penaltiesData[operator].filter(p => p.id !== id);
            }
            await sendToSheets('deletePenalty', { id: id });
            updatePenaltiesUI();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        function updateSettingsUI() {
            const operatorsList = document.getElementById('operatorsList');
            operatorsList.innerHTML = allOperators.map(op => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; margin-bottom: 6px;">
                    <span style="font-size: 12px;">${op}</span>
                    <button class="btn-secondary" onclick="deleteOperator('${op}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');

            const anketasList = document.getElementById('anketasList');
            anketasList.innerHTML = allAnkety.map(anketa => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; margin-bottom: 6px;">
                    <span style="font-size: 12px;">${anketa}</span>
                    <button class="btn-secondary" onclick="deleteAnketa('${anketa}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');

            const adminList = document.getElementById('adminList');
            adminList.innerHTML = allAdmins.map(admin => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(99, 102, 241, 0.05); border-radius: 6px; margin-bottom: 6px;">
                    <span style="font-size: 12px;">${admin} (${ADMIN_PERCENT}%)</span>
                    <button class="btn-secondary" onclick="deleteAdmin('${admin}')">–£–¥–∞–ª–∏—Ç—å</button>
                </div>
            `).join('');
        }

        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        async function addOperator() {
            const name = document.getElementById('newOperatorName').value.trim();
            if (!name) { showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!'); return; }
            if (allOperators.includes(name)) { showError('–°—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
            allOperators.push(name);
            await sendToSheets('addOperator', { name: name });
            closeModal('addOperatorModal');
            document.getElementById('newOperatorName').value = '';
            updateOperatorSelects();
            updateSettingsUI();
            updateReportsOperatorList();
            updateAdvanceSelector();
            updatePenaltySelector();
            showSuccess('‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!');
        }

        async function addAnketa() {
            const name = document.getElementById('newAnketaName').value.trim();
            if (!name) { showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!'); return; }
            if (allAnkety.includes(name)) { showError('–°—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
            allAnkety.push(name);
            await sendToSheets('addAnketa', { name: name });
            closeModal('addAnketaModal');
            document.getElementById('newAnketaName').value = '';
            updateAnketaSelector();
            updateSettingsUI();
            showSuccess('‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!');
        }

        async function addAdmin() {
            const name = document.getElementById('newAdminName').value.trim();
            if (!name) { showError('–í–≤–µ–¥–∏—Ç–µ –∏–º—è!'); return; }
            if (allAdmins.includes(name)) { showError('–°—É—â–µ—Å—Ç–≤—É–µ—Ç!'); return; }
            allAdmins.push(name);
            await sendToSheets('addAdmin', { name: name });
            closeModal('addAdminModal');
            document.getElementById('newAdminName').value = '';
            updateSettingsUI();
            showSuccess('‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ!');
        }

        async function deleteOperator(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
            allOperators = allOperators.filter(op => op !== name);
            await sendToSheets('deleteOperator', { name: name });
            updateOperatorSelects();
            updateSettingsUI();
            updateReportsOperatorList();
            updateAdvanceSelector();
            updatePenaltySelector();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        async function deleteAnketa(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
            allAnkety = allAnkety.filter(a => a !== name);
            await sendToSheets('deleteAnketa', { name: name });
            updateAnketaSelector();
            updateSettingsUI();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        async function deleteAdmin(name) {
            if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${name}?`)) return;
            allAdmins = allAdmins.filter(a => a !== name);
            await sendToSheets('deleteAdmin', { name: name });
            updateSettingsUI();
            showSuccess('‚úì –£–¥–∞–ª–µ–Ω–æ!');
        }

        function showError(message) {
            const msg = document.createElement('div');
            msg.className = 'success-message';
            msg.textContent = '‚ùå ' + message;
            msg.style.background = 'var(--danger)';
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        function showSuccess(message) {
            const msg = document.createElement('div');
            msg.className = 'success-message';
            msg.textContent = message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3000);
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkConnection();
            if (localStorage.getItem('spreadsheetId') && localStorage.getItem('scriptUrl')) {
                switchTab('add-income');
            }
            init();
        });
    </script>
</body>
</html>
